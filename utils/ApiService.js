const moment = require("moment/moment");
const {ButtonBuilder, ButtonStyle, ActionRowBuilder} = require("discord.js");
const axios = require("axios");
const { apiKey, baseApi } = require('../config.json');

function ApiService() {}

const config = {
    headers: {
        apiKey: apiKey
    }
};

ApiService.prototype.getLatestCVEs = async function() {

    const today = moment(new Date()).format("YYYY-MM-DDT00:00:00");
    const now = moment(new Date()).format("YYYY-MM-DDT23:59:59");

    const response = await axios.get(baseApi + '?pubStartDate=' + today + '&pubEndDate=' + now + '&resultsPerPage=20&StartIndex=0', config)
        .then((response) => {
            let vulnerabilities = response.data.vulnerabilities;

            // Sorting of object by published date of vulnerability, and slice by 3 elements
            vulnerabilities = vulnerabilities.sort((a,b)=>
                a.published > b.published ? 1:-1
            ).sort((a,b)=> {
                if (a.published === b.published) {
                    return a.published - b.published;
                }
            }).slice(0,3);

            //Format the response of the discord bot
            let botResponse = '';
            const buttons= [];
            for (const vulnerability of vulnerabilities) {
                botResponse += "ðŸ”“ **" + vulnerability.cve.id + '**\n';
                botResponse += "Fecha: " + moment(vulnerability.cve.published).format('DD-MM-YYYY HH:mm:ss') + "\n\n";
                botResponse += vulnerability.cve.descriptions[1] != undefined ?
                    vulnerability.cve.descriptions[1].value + "\n\n" : vulnerability.cve.descriptions[0].value + "\n\n";
                const detail = new ButtonBuilder()
                    .setCustomId(vulnerability.cve.id)
                    .setLabel("MÃ¡s informaciÃ³n " + vulnerability.cve.id)
                    .setStyle(ButtonStyle.Primary);
                buttons.push(detail);
            }
            const row = new ActionRowBuilder().addComponents(buttons);

            return {
                content: botResponse,
                components: [row]
            };
        });
    return response;
};

ApiService.prototype.getCVE = async function(id) {
    const response = await axios.get(baseApi + '?cveId=' + id, config)
        .then((response) => {
            let botResponse = '';

            botResponse += "**" + response.data.vulnerabilities[0].cve.id + "**\n";
            botResponse += "Fecha: " + moment(response.data.vulnerabilities[0].cve.published).format("DD-MM-YYYY HH:mm:ss") + "\n";
            botResponse += "Estado: " + response.data.vulnerabilities[0].cve.vulnStatus + "\n\n";

            if (response.data.vulnerabilities[0].cve.metrics != undefined) {
                const score = response.data.vulnerabilities[0].cve.metrics.cvssMetricV31[0].cvssData.baseScore;

                botResponse += "PuntuaciÃ³n: ";

                if (score >= 8){
                    botResponse += "```diff\n-" + score + "```\n";
                } else {
                    botResponse += score + "\n";
                }

                const attackComplexity = response.data.vulnerabilities[0].cve.metrics.cvssMetricV31[0].cvssData.attackComplexity;

                switch (attackComplexity) {
                    case 'LOW':
                        botResponse += "Complejidad de ataque: *BAJA*. \n\n";
                        break;
                    case 'MEDIUM':
                        botResponse += "Complejidad de ataque: *MEDIA*. \n\n";
                        break;
                    case 'HIGH':
                        botResponse += "Complejidad de ataque: *ALTA*. \n\n";
                        break;
                }
            }

            if (response.data.vulnerabilities[0].cve.weaknesses != undefined) {
                botResponse += "Debilidades: \nSource: " + response.data.vulnerabilities[0].cve.weaknesses[0].source + "\n";
                botResponse += "Type: " + response.data.vulnerabilities[0].cve.weaknesses[0].type + "\n";
                botResponse += "CWE: " + response.data.vulnerabilities[0].cve.weaknesses[0].description[0].value + "\n\n";
            }

            botResponse +=  response.data.vulnerabilities[0].cve.descriptions[1] != undefined
                ? response.data.vulnerabilities[0].cve.descriptions[1].value + "\n\n" : response.data.vulnerabilities[0].cve.descriptions[0].value + "\n\n";

            botResponse +=  "Referencias: \n\n";
            for (const reference of response.data.vulnerabilities[0].cve.references) {
                botResponse +=  reference.url + "\n";
            }

            return {
                content: botResponse
            };
        });
    return response;
};

module.exports = ApiService;